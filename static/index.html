<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PII Shield UI</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --accent: #22c55e;
      --muted: #94a3b8;
      --text: #e2e8f0;
      --danger: #f87171;
    }
    body {
      margin: 0;
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at 20% 20%, #1f2937, #0b1224 45%), var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 24px;
    }
    .container {
      width: min(1100px, 100%);
      display: grid;
      gap: 16px;
    }
    h1 {
      margin: 0;
      font-size: 28px;
      letter-spacing: -0.02em;
    }
    .panel {
      background: var(--panel);
      border: 1px solid #1f2937;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
    }
    label {
      display: block;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    input[type="text"], textarea {
      width: 100%;
      background: #0b1220;
      border: 1px solid #1f2937;
      color: var(--text);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      box-sizing: border-box;
    }
    textarea { min-height: 140px; resize: vertical; }
    .row { display: grid; gap: 12px; grid-template-columns: 1fr 1fr; }
    .actions {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    button {
      background: var(--accent);
      color: #0b1220;
      border: none;
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease;
      box-shadow: 0 6px 18px rgba(34, 197, 94, 0.35);
    }
    button.secondary { background: #1f2937; color: var(--text); box-shadow: none; }
    button:hover { transform: translateY(-1px); }
    .small { font-size: 13px; color: var(--muted); }
    pre {
      background: #0b1220;
      border: 1px solid #1f2937;
      border-radius: 10px;
      padding: 12px;
      overflow-x: auto;
      margin: 0;
      font-size: 13px;
      line-height: 1.35;
    }
    .status {
      font-size: 13px;
      margin-top: 6px;
    }
    .status.error { color: var(--danger); }
    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #0b1220;
      border: 1px solid #1f2937;
      font-size: 12px;
      color: var(--muted);
    }
    .flex { display: flex; align-items: center; gap: 8px; }
    .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="panel">
      <div class="flex" style="justify-content: space-between; flex-wrap: wrap;">
        <div>
          <h1>PII Shield Console</h1>
          <div class="small">Submit prompts through the redaction proxy and view audit stats.</div>
        </div>
        <div class="tag">
          <span>API base</span>
          <input id="baseUrl" type="text" value="http://127.0.0.1:8000" style="width: 180px; padding: 6px 8px; border-radius: 8px; border: 1px solid #1f2937; background: #0f172a; color: var(--text); font-size: 12px;">
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="row">
        <div>
          <label for="model">Model</label>
          <input id="model" type="text" value="llama3.1:8b">
        </div>
        <div>
          <label for="system">System (optional)</label>
          <input id="system" type="text" placeholder="You are a helpful assistant.">
        </div>
      </div>
      <div style="margin-top: 12px;">
        <label for="prompt">User message</label>
        <textarea id="prompt" placeholder="Enter a prompt that may include PII..."></textarea>
      </div>
      <div class="actions">
        <button id="sendBtn">Send to /v1/chat/completions</button>
        <label class="flex small" style="gap: 6px; cursor: pointer;">
          <input id="showMasked" type="checkbox" checked>
          Show payload sent to API
        </label>
        <span class="status" id="status"></span>
      </div>
    </div>

    <div class="panel grid-2">
      <div>
        <div class="flex" style="justify-content: space-between; margin-bottom: 8px;">
          <div class="small">Response JSON</div>
        </div>
        <pre id="responseBox">Waiting for request...</pre>
      </div>
      <div>
        <div class="flex" style="justify-content: space-between; margin-bottom: 8px;">
          <div class="small">Headers + Sent Payload</div>
        </div>
        <pre id="metaBox">Waiting for request...</pre>
      </div>
    </div>

    <div class="panel">
      <div class="flex" style="justify-content: space-between;">
        <div class="small">Audit stats (/admin/stats)</div>
        <button class="secondary" id="refreshStats">Refresh</button>
      </div>
      <pre id="statsBox">Press refresh to load.</pre>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const statusEl = $("status");
    const responseBox = $("responseBox");
    const metaBox = $("metaBox");
    const statsBox = $("statsBox");

    async function sendRequest() {
      const base = $("baseUrl").value.trim().replace(/\/$/, "");
      const model = $("model").value.trim();
      const system = $("system").value.trim();
      const prompt = $("prompt").value;
      if (!base) return setStatus("Base URL required", true);
      if (!model) return setStatus("Model is required", true);
      if (!prompt) return setStatus("User message is required", true);

      const messages = [];
      if (system) messages.push({ role: "system", content: system });
      messages.push({ role: "user", content: prompt });

      const payload = { model, messages, stream: false };

      setStatus("Sending...", false);
      metaBox.textContent = "Waiting for response...";
      responseBox.textContent = "Waiting for response...";

      try {
        const res = await fetch(`${base}/v1/chat/completions`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        const json = safeParse(text);

        responseBox.textContent = json ? JSON.stringify(json, null, 2) : text;

        const headers = {};
        res.headers.forEach((v, k) => headers[k] = v);

        const showPayload = $("showMasked").checked;
        metaBox.textContent = JSON.stringify({
          status: res.status,
          headers,
          sent_payload: showPayload ? payload : "hidden"
        }, null, 2);

        setStatus(res.ok ? "Success" : "Upstream error", !res.ok);
        fetchStats(); // refresh stats after request
      } catch (err) {
        setStatus(`Error: ${err}`, true);
        metaBox.textContent = "Request failed.";
        responseBox.textContent = "";
      }
    }

    function safeParse(text) {
      try { return JSON.parse(text); } catch { return null; }
    }

    function setStatus(msg, isError) {
      statusEl.textContent = msg;
      statusEl.className = "status" + (isError ? " error" : "");
    }

    async function fetchStats() {
      const base = $("baseUrl").value.trim().replace(/\/$/, "");
      if (!base) return;
      statsBox.textContent = "Loading...";
      try {
        const res = await fetch(`${base}/admin/stats`);
        const text = await res.text();
        const json = safeParse(text);
        statsBox.textContent = json ? JSON.stringify(json, null, 2) : text;
      } catch (err) {
        statsBox.textContent = `Failed to load stats: ${err}`;
      }
    }

    $("sendBtn").addEventListener("click", sendRequest);
    $("refreshStats").addEventListener("click", fetchStats);
  </script>
</body>
</html>
